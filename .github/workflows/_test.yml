name: Test

on:
  workflow_call:
    inputs:
      python-version:
        description: Python version
        required: true
        type: string

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup UV
        uses: ./.github/actions/uv_setup
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]"

      - name: Start CockroachDB
        run: |
          docker run -d --name cockroachdb \
            -p 26257:26257 \
            -p 8080:8080 \
            cockroachdb/cockroach:latest \
            start-single-node --insecure
          
          # Wait for CockroachDB to be ready
          echo "Waiting for CockroachDB to start..."
          for i in {1..30}; do
            if docker exec cockroachdb ./cockroach sql --insecure -e "SELECT 1" 2>/dev/null; then
              echo "âœ… CockroachDB is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          # Verify it's running
          docker exec cockroachdb ./cockroach version

      - name: Run unit tests
        run: |
          pytest tests/unit -v --tb=short

      - name: Run integration tests
        env:
          USE_TESTCONTAINER: "false"
          COCKROACHDB_URL: "cockroachdb://root@localhost:26257/defaultdb?sslmode=disable"
        run: |
          pytest tests/integration -v --tb=short

      - name: Generate coverage report
        if: inputs.python-version == '3.12'
        run: |
          pytest tests --cov=langchain_cockroachdb --cov-branch --cov-report=xml --cov-report=html

      - name: Upload coverage reports to Codecov
        if: inputs.python-version == '3.12'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: integration
          name: codecov-umbrella
          fail_ci_if_error: false
